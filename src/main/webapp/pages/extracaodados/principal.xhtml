<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="../templates/template.xhtml"
	xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core">
	
	<ui:define name="bread">
		<p:breadCrumb>  
			<p:menuitem value="Home"/>  
			<p:menuitem value="Extração de Dados"/>  
		</p:breadCrumb>  
	</ui:define>
	
	<ui:define name="content">
		<h:form id="form" style="max-width: 1216px; margin: 0 auto">
			<p:panelGrid style="vertical-align: central; width: 100%">
				<f:facet name="header">  
					<p:row>  
						<p:column colspan="2">Filtros para extração</p:column>
					</p:row>
				</f:facet>
				<p:row>
					<p:column colspan="2" style="background: #FFCC22">
                        <b>Informe um ou mais filtros para realizar a extração de dados.</b>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Tipo de Manifestação</p:column>
                    <p:column style="width: 80%">
						<p:selectOneMenu  value="#{mBExtracaoDados.idTipoManifestacao}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />
                            <f:selectItems var="tipo" value="#{mBTipoManifestacao.todos}" itemValue="#{tipo.idTipoManifestacao}" itemLabel="#{tipo.nmTipoManifestacao}" />
                        </p:selectOneMenu>
					</p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Período de abertura (De)</p:column>
                    <p:column style="width: 80%">
                    	<p:calendar value="#{mBExtracaoDados.dtCadastroInicio}" pattern="dd/MM/yyyy" />
					</p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Período de abertura (Até)</p:column>
                    <p:column style="width: 80%">
                    	<p:calendar value="#{mBExtracaoDados.dtCadastroFim}" pattern="dd/MM/yyyy" />
					</p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Status da ocorrência</p:column>
                    <p:column style="width: 80%">
                        <p:selectOneMenu value="#{mBExtracaoDados.idStatus}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />  
                            <f:selectItems var="tipo" value="#{mBExtracaoDados.statusManifestacaoRelatorioEnums}" itemValue="#{tipo}" itemLabel="#{tipo.descricao}" />
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Classificação</p:column>
                    <p:column style="width: 80%">
                        <p:selectOneMenu value="#{mBExtracaoDados.idClassificacao}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />  
                            <f:selectItems var="classificacao" value="#{mBClassificacao.todos}" itemValue="#{classificacao.idClassificacao}" itemLabel="#{classificacao.dsClassificacao}" />
                            <p:ajax process="@this" update="ddlSubClassificacao" 
                                    event="change" />
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Subclassificação</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu id="ddlSubClassificacao"  value="#{mBExtracaoDados.idSubClassificacao}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />  
                            <f:selectItems var="subclassificacao" value="#{mBExtracaoDados.subClassificacaoClassificacao}" itemValue="#{subclassificacao.idSubClassificacao}" itemLabel="#{subclassificacao.dsSubClassificacao}" />
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Área solucionadora</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu value="#{mBExtracaoDados.idAreaSolucionada}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />  
                            <f:selectItems var="areasolucionadora" value="#{mBUnidade.todos}" itemValue="#{areasolucionadora.idUnidade}" itemLabel="#{areasolucionadora.nmUnidade}" />
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Unidade</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu value="#{mBExtracaoDados.idUnidade}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />  
                            <f:selectItems var="unidade" value="#{mBUnidade.todos}" itemValue="#{unidade.idUnidade}" itemLabel="#{unidade.nmUnidade}" />
                            <p:ajax update="ddlOperador" 
                                    event="change" />
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Operador</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu id="ddlOperador" value="#{mBExtracaoDados.idUsuario}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />  
                            <f:selectItems var="usuario" value="#{mBExtracaoDados.operadores}" itemValue="#{usuario.idUsuario}" itemLabel="#{usuario.nmUsuario}" />
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Prioridade</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu value="#{mBExtracaoDados.idPrioridade}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />  
                            <f:selectItems var="prioridade" value="#{mBPrioridade.todos}" itemValue="#{prioridade.idPrioridade}" itemLabel="#{prioridade.nmPrioridade}" />
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Sexo</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu id="sexo" value="#{mBExtracaoDados.idSexo}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />  
                            <f:selectItems value="#{mBEnum.sexoEnums}" var="sexo" itemLabel="#{sexo.descricao}" itemValue="#{sexo.id}"/>
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Faixa Etária</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu value="#{mBExtracaoDados.idFaixaEtaria}" style="width: 300px;">
                            <f:selectItem itemLabel=" - Selecione -" itemValue="" />
                            <f:selectItems value="#{mBFaixaEtaria.todos}"
                                           var="faixaEtaria"
                                           itemLabel="#{faixaEtaria.nmFaixaEtaria}"
                                           itemValue="#{faixaEtaria.idFaixaEtaria}"/>
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Grau de Instrução</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu value="#{mBExtracaoDados.idGrauInstrucao}" style="width: 300px;">
                            <f:selectItem itemLabel=" - Selecione -" itemValue="" />
                            <f:selectItems value="#{mBGrauInstrucao.todos}"
                                           var="grauInstrucao"
                                           itemLabel="#{grauInstrucao.nmGrauInstrucao}"
                                           itemValue="#{grauInstrucao.idGrauInstrucao}"/>
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Raça</p:column>
                    <p:column style="width: 80%">
                        <p:selectOneMenu id="slcRaca"  value="#{mBExtracaoDados.idRaca}" style="width: 300px;">  
                            <f:selectItem itemLabel="- Selecione -" />
                            <f:selectItems value="#{mBEnum.racaEnums}" var="raca" itemLabel="#{raca.descricao}" itemValue="#{raca.id}"/>
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">UF</p:column>
                    <p:column style="width: 80%">
                        <p:selectOneMenu id="slcEstado" value="#{mBExtracaoDados.idUf}" style="width: 300px;">
                            <f:selectItem itemLabel=" - Selecione -" itemValue="" />
                            <f:selectItems value="#{localidadeBean.estados}"
                                           var="uf"
                                           itemLabel="#{uf.nmUF}"
                                           itemValue="#{uf.idUF}" />
                            <p:ajax update="localidade" event="change" />
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Município</p:column>
                    <p:column style="width: 80%">
                    	<p:autoComplete id="localidade" 
                    					size="46"
                    					minQueryLength="2"
                    					value="#{mBExtracaoDados.nmLocalidade}"
                    					completeMethod="#{mBExtracaoDados.completaMunicipio}" disabled="#{mBExtracaoDados.idUf eq '' || empty mBExtracaoDados.idUf}" />  
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Tipo de Atraso</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu value="#{mBExtracaoDados.atrasoManifestacaoEnum}" style="width: 300px;"> 
                            <f:selectItem itemLabel="- Selecione -" />
                            <f:selectItems value="#{mBEnum.atrasoManifestacaoEnum}" var="atraso" itemLabel="#{atraso.descricao}" itemValue="#{atraso}"/>
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Região</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu value="#{mBExtracaoDados.regiao}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" />
                            <f:selectItems value="#{mBEnum.regiaoEnums}" var="r" itemLabel="#{r.nome}" itemValue="#{r}"/>
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Atendente</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu id="ddlCriadaPor" value="#{mBExtracaoDados.idUsuarioCriador}" style="width: 300px;">
                            <f:selectItem itemLabel="- Selecione -" itemValue="" />  
                            <f:selectItems var="usuario" value="#{mBUsuario.todosUsuariosOuvidor}" itemValue="#{usuario.idUsuario}" itemLabel="#{usuario.nmUsuario}" />
                        </p:selectOneMenu>
                    </p:column>
                </p:row>
                <p:row>
                    <p:column style="width: 20%">Tipo Manifestante</p:column>
                    <p:column style="width: 80%">
                    	<p:selectOneMenu value="#{mBExtracaoDados.tipoManifestanteEnum}" style="width: 300px;">
							<f:selectItem itemLabel="- Selecione -" />
							<f:selectItems value="#{mBEnum.tipoManifestanteEnums}" var="r" itemLabel="#{r.descricao}" itemValue="#{r}"/>
                    	</p:selectOneMenu>
                    </p:column>
                </p:row>
                
                <p:row>  
                    <p:column colspan="2" styleClass="left">
                        <p:panelGrid style="width: 100%">
                            <p:row>
                                <p:column style="text-align: center; width: 100%" styleClass="ui-widget-header">
                                    <p:commandButton value="Consultar" actionListener="#{mBExtracaoDados.consultarManifestacoes()}" update="tabelaManifestacoes" ajax="false" />
                                    <p:spacer width="20px"/>
                                    <p:commandButton value="Extrair Excel" actionListener="#{mBExtracaoDados.download()}"  ajax="false" />
                                </p:column>
                            </p:row>
                        </p:panelGrid>
                    </p:column>
                </p:row> 
            </p:panelGrid>
            <p:spacer height="20px;" />
            <p:dataTable id="tabelaManifestacoes"
                         value="#{mBExtracaoDados.manifestacoes}"
                         paginator="true" rows="10"
                         rowsPerPageTemplate="10,15,20"      
                         paginatorPosition="bottom"
                         paginatorTemplate="{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                         emptyMessage="Nenhuma manifestação foi encontrada"
                         var="manifestacao"
                         rowStyleClass="#{empty rowIx or rowIx mod 2 ne 0 ? 'even-row' : 'odd-row'}" 
                         rowIndexVar="rowIx" >
                <f:facet name="header">
                    <h:outputText value="Manifestações Encontradas: #{mBExtracaoDados.manifestacoes.size()}"/>
                </f:facet>
                <!-- AMARELO - style="color: #e1cf07;" -->
                <!-- LARANJA - style="color: #ff8b00;" -->
                <!-- VERMELHO - style="color: #fe0000;" -->
                <p:column style="width: 10%;" headerText="Nº" filterBy="#{manifestacao.nrManifestacao}" filterMatchMode="contains" sortBy="#{manifestacao.nrManifestacao}">
                    <h:outputText value="#{manifestacao.nrManifestacao}"/>
                </p:column>

                <p:column style="width: 10%;">
                    <f:facet name="header">
                        <h:outputText value="Dt. Registro (R)"/><br />
                        <h:outputText value="Dt. Atualização (A)" style="white-space: nowrap"/>
                    </f:facet>
                    <h:outputText value="R: "/>
                    <h:outputText value="#{manifestacao.dtCadastro}">
                        <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Sao_Paulo" />
                    </h:outputText>
                    <br />
                    <h:outputText value="A: "/>
                    <h:outputText value="#{manifestacao.dtUltimaAtualizacao}">
                        <f:convertDateTime pattern="dd/MM/yyyy" timeZone="America/Sao_Paulo" />
                    </h:outputText>
                </p:column>

                <p:column headerText="Manifestante" style="width: 23%;" filterBy="#{manifestacao.nmPessoa}" filterMatchMode="contains" sortBy="#{manifestacao.nmPessoa}">
                    <h:outputText value="#{manifestacao.nmPessoa}" />
                </p:column>

                <p:column headerText="Tipo" style="width: 10%;" filterBy="#{manifestacao.idTipoManifestacao.nmTipoManifestacao}" filterMatchMode="contains" sortBy="#{manifestacao.idTipoManifestacao.nmTipoManifestacao}">
                    <h:outputText value="#{manifestacao.idTipoManifestacao.nmTipoManifestacao}"/>
                </p:column>

                <p:column headerText="Prioridade" style="width: 10%;" filterBy="#{manifestacao.idPrioridade.nmPrioridade}" filterMatchMode="contains" sortBy="#{manifestacao.idPrioridade.nmPrioridade}">
                    <h:outputText value="#{manifestacao.idPrioridade.nmPrioridade}"/>
                </p:column>

                <p:column headerText="Status" style="width: 10%;" filterBy="#{mBEnum.getStatusManifestacaoEnum(manifestacao.stStatusManifestacao).descricao}" filterMatchMode="contains" sortBy="#{mBEnum.getStatusManifestacaoEnum(manifestacao.stStatusManifestacao).descricao}">
                    <h:outputText value="#{mBEnum.getStatusManifestacaoEnum(manifestacao.stStatusManifestacao).descricao}"/>
                </p:column>

                <p:column headerText="Unidade(s)"  style="width: 20%;" filterBy="#{mBListarManifestacoes.getUnidadesEncaminhadas(manifestacao)}" filterMatchMode="contains" sortBy="#{mBListarManifestacoes.getUnidadesEncaminhadas(manifestacao)}">
                    <h:outputText value="#{mBListarManifestacoes.getUnidadesEncaminhadas(manifestacao)}"/>
                </p:column>
                
                <p:column headerText="Dias em Atraso" style="width:5%;" sortBy="#{mBListarManifestacoes.diasAtrasoAoManifestante(manifestacao)}">
					<h:outputText value="#{mBListarManifestacoes.diasAtrasoAoManifestante(manifestacao)}" />
				</p:column>
                
                <p:column headerText="Ver">
					<div style="width: 50px; display: inline-block;">
						<p:commandButton id="cbViewManifestacao" icon="ui-icon-search"
							title="Visualizar"
							action="/pages/manifestacao/administrar.xhtml"
							actionListener="#{mBManifestacao.setManifestacao(manifestacao)}"
							ajax="false" style="float: left">
							<f:actionListener binding="#{mBManifestacao.init()}" />
						</p:commandButton>
					</div>
				</p:column>
            </p:dataTable>
        </h:form>
    </ui:define>
</ui:composition>
